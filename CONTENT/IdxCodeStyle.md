PSR: PHP Standards Recommendations

# 一：前言

------

源码文件必须采用无BOM头的UTF-8编码。

编码风格没有太多的好坏之分, 最重要的是风格保持一致。

编码规范有助于规范我们编码的风格，使代码具有更好的可读性。

PHP编码规范 包含[psr-1](http://www.php-fig.org/psr/psr-1/) [psr-2](http://www.php-fig.org/psr/psr-2/) [psr-4](http://www.php-fig.org/psr/psr-4/) 规范，只有1条与PSR规范冲突。

# 二：规范等级

------

现针对PHP代码的 排版规则、命名规则、注释规则、编码原则、安全编码、日志等几个方面，

将PHP编码规范整理为 5种等级，其中0级为最高等级。

温馨提示：0级-3级必须严格遵守，否则会影响个人绩效（详细 规范等级 请见：[PHP编码规范（For : EP）](http://wiki.intra.xiaojukeji.com/pages/viewpage.action?pageId=95327034)）。 

# 三：规范详情 

------

## 1. Level 0级规范

1.1  **全局变量**以g_开头，如：$g_count。

1.2  **常量**命名使用全部大写字符，单词之间以'_'连接，如：PAGE_NUM。

1.3  关键字**true, false, null**必须小写。

1.4  **私有函数、私有变量**命名需加上 '_'前缀，如：private function _myPrivateFunc() {}*、*private $_aNum。

1.5  所有的**define语句**，常量必须用单引号**'  '**包括起来，如：define('PAGE_NUM', 3)。

1.6  **require**后面需要带上**括号，**如：require_once("a.php")。

1.7  所有的属性(property)和方法(method) **必须有可见性声明**；抽象(abstract)和终结(final)声明必须在可见性声明之前，而静态(static)声明必须在可见性声明之后。

## 2.变量及常量相关

2.1 **变量**命名使用camelCase，如 $sName，$iAge（建议增加一个字符的类型前缀，如 a，s，i，b，o等）。

2.2 变量在生命周期中，其类型不要发生变化。

2.3 使用变量前赋初值，提高可读性，也避免误用别处定义的同名变量。

2.4 同一个代码块的变量定义，应该尽量集中在块的开始位置，提高可读性。

2.5 当你不确定变量是何种类型时，在使用前请将它强制转化成你需要的类型。

2.6 类型转换应该发生在赋值的时候，而不是发生在使用的时候，特殊情况除外。

2.7 **类型转换**，尽量使用(string)格式，而不是strval();  其他类型同理,如：使用（int）而不是intval()。 (int)比intval()性能高出3~6倍。

2.8 避免使用global全局变量。

2.9 如果必须要用全局变量，所有的**全局变量**应该写在函数的**最开头**，并且和后面的代码以**空行隔开**。

2.10 在头文件中定义全局变量必须用$GLOBALS的形式，这样可以避免在函数中include导致的作用域问题。

2.11整形参数，需要用intval函数处理，注意intval返回有符号的数值，若数值过大，可以考虑使用floatval。  如：$iSalary = intval(‘11’,16)。

2.12 对于代码中的常量，必须用常量或define表示，不允许直接写在代码中。

## 3.数组相关

3.1 初始化array如果采用多行结构时，数据项部分需要缩进，且**最后一个**数据项后面的**逗号不可省略** 。

3.2 对数组做遍历前先判断是否为空。

## 4.控制结构相关

4.1  elseif语句使用elseif形式，不使用else if形式。

4.2 关键字与其后的左括号之间有一个空格

4.3 控制结构的右小括号和左花括号间必须有个空格

4.4 else和elseif与前面的右花括号在同一行

4.5 **关键字**的左花括号 { **不用单独一行**。即 开始的大括号位于一行的末尾，结束的括号位于最末一行后，且独占一行。

4.6 if/while等结构体，即使只有一行，也必须加上左右花括号，**不允许写成一行**。

4.7 if 语句的条件若较多较长，应折行；新行**以逻辑运算符起始**，与第一行 if 左括号后的第一个字符对齐；折行后，每行条件具有独立而明确的语义。

4.8 复杂的表达式，使用括号表明优先级，而不完全依赖运算符优先级。

4.9 避免由于对错误的条件做判断带来if的嵌套。

4.10 进行==判断时，建议把常量放在前面，避免误写成赋值操作。

4.11 对于if，else if分支，补全最后的else分支。

4.12 尽量使用$ii, $jj, $kk等作为循环计数变量，不仅比较好识别，更好查找；如：for ($ii = 0; $ii < 10; $ii++)。

4.13 把重复调用放在循环体外。

4.14 能用foreach的就不要用for，能用for的就不要用while。

4.15  while/do while/for/foreach/try catch格式同if elseif else  

4.16  switch结构里，case必须从switch开始缩进一次，break必须与case的body体保持一样的缩进；

4.17  switch结构里，当故意不设置break时，必须添加一行注释，如//no break 

4.18 switch 语句中使用default。

4.19 禁止使用and、or，而是使用 &&、||。

## 5.普通function及类method相关

5.1 函数名与左括号之间不应有任何字符包括空格。

5.2 函数调用的左括号与其第一个参数之间不应有任何字符(包括空格)，  最后一个参数与右括号之间不应有任何字符(包括空格)，  参数列表的逗号后面应有一个空格。

5.3 **函数和类方法的**的左花括号 { **不用单独一行**。即 开始的大括号位于一行的末尾，结束的括号位于最末一行后，且独占一行。**（类method的左花括号位置规则 与psr冲突，以我们的规范为准！！！）**

5.4 对传入或返回的参数进行类型检查和显式转换。

5.5 函数参数的个数建议不超过5个，多余的则使用数组形式传参。

5.6 不明确的参数尽可能靠后，有默认值的参数最后。

5.7 方法的参数列表可以以多行分割，每个子序列行只缩进一次

5.8 当方法的参数列表以多行分割时，第一个参数必须单独一行，且每行只能一个参数

5.9 当方法的参数列表以多行分割时，右小括号和左花括号必须放在一起，并且单独一行

5.10 类method命名采用**驼峰命名**, 普通function采用**过程函数风格**命名。

5.11 对于函数返回值的判断，特别是true/false，用===/!== 而不是==/!=。

5.12 闭包的规则同function  

## 6.类相关

6.1 类命名使用PascalCase，如：class SuperCass {}。

6.2 生成一个对象时，必须使用new Classname()的方式，不能用new Classname的方式。

**6.3 类(class)的左花括号必须**放到其声明下面**自成一行**，右花括号则必须放到类主体下面自成一行。

6.4 类构造函数名，禁止使用类名，强制使用 __construct 作为构造函数名。

6.5 关键字extends和implements必须与class在同一行

6.6  implements后的接口列表，可以以多行分割，每个子序列行只缩进一次

6.7 如果implements后的接口序列用多行分割，则第一个接口必须单独一行，且每行只有一个接口

6.8 对于不应实例化的父类使用abstract关键字限定。

6.9 对于无需子类化的实体类 以及 不应重载的方法使用final关键字限定。

6.10 对于仅用于某个函数或类的全局变量，使用static的局部变量或者类成员变量代替。

6.11 对于object对象，要用类型验证，如assert_instances_of、instanceof。

## 7.文件相关

7.1 所有的PHP文件,必须以一个空行结束。

7.2 配置文件名称为 **'config_'+****配置文件名+'.php'，**不涉及类的都**小写**通过”_”连接，如：**config_phone_operator.php** 。

7.3 所有的文件路径都需要利用框架提供的宏写成**绝对路径**。

7.4 除非特殊情况，否则不允许使用 require 和 include，而使用对应的 require_once/include_once。

7.5 对于文件更新操作，必须先写到一个临时文件中，然后用rename/mv操作。切忌直接在原文件上做更新。

7.6 文件(除了类)命名使用camelCase，如：pCancelOrder.php。 类文件名必须符合所用框架自动加载规范，常见composer的psr4。(待定)

## 8.命名空间相关

8.1 在命名空间(namespace)的声明下面必须有一行空行，并且在导入(use)的声明下面也必须有一行空行。

8.2 use声明必须在namespace声明后面。

8.3 每个use只能声明一个keyword。

 8.4 对于PHP全局类的使用，请遵循PHP手册 <http://php.net/manual/zh/language.namespaces.fallback.php>

在一个命名空间中，当 PHP 遇到一个非限定的类、函数或常量名称时，它使用不同的优先策略来解析该名称。类名称总是解析到当前命名空间中的名称。因此在访问系统内部或不包含在命名空间中的类名称时，必须使用完全限定名称，例如： 

## 9.编码原则及排版相关

9.1 **不要使用**php闭合标签"**?>**"。

9.2 非空白行的结尾必须不能尾随空格

9.3 每行不能超过一条语句

9.4 不能使用var关键字声明属性

9.5 一条语句不能声明多个属性

9.6 对于长时间运行的脚本并且含有**占用内存较大**的变量，使用完后必须**unset掉**，避免内存占用过多。

9.7 程序块要采用缩进风格编写，缩进的空格数为4个。（以tab为缩进的，请将缩进设定为一个soft tab即4个空格！） 

9.8   对于一些系统操作，使用php内置的函数，例如rename、touch等即可，**尽量避免使用exec调用shell命令。**

9.9 配置项与PHP代码分离，不随git发布( 配置放git中不能保证最新且上线PHP代码的时候配置存在被覆盖的风险)。

9.10 **预定义变量一律使用短格式** ，即：$_POST、$_GET、$_SERVER、$_ENV、$GLOBALS、$_COOKIE、$_SESSION、$_REQUEST、$_FILES等。

9.11 操作符的前后保留一个空格，如 $a **=** 1; if ($a **>** $b)。

9.12 避免在controller中直接操作数据库。

9.13 避免在函数构造器中使用load database操作。

9.14 使用active record模式与db进行交互、慎用直接拼装sql操作。

9.15 通用缩略词使用全大写字母，如ID、HTML。

9.16 尽量不要在php代码中出现HTML标签，将模板和代码分离。

9.17 **字符串**尽量用**' '**而不是" "进行引用，一个是效率问题，一个是安全问题

9.18 避免使用PHP逻辑代码作为配置，以降低改配置的危险性。

9.19 错误码使用统一文件集中配置，并且使用常量，而不应裸写数字。

9.20 适当控制每行代码的长度(一般不超过80个字符，最多不要超过120个字符)；一个函数不得超过500行，建议控制在100行以内。 

9.21 多行的”=”可能的话尽量用空格对齐。 

9.22 避免使用extract()。

9.23 避免使用eval()。

9.24 错误分支要使用异常处理。

9.25 换行回车使用Unix的”\n“，不要用MSDOC的”\r\n“ 及 OS9 "\r“。

9.26 避免使用替代语法，如endwhile等。

9.27 适当添加空白行，有助于提高代码可读性，同时将相关代码以块分割

## 10.注释及日志相关

**10.1 必要的地方使用非文档性注释，提高代码易读性。**

10.2 在function函数和method类方法的**内部**，使用**//**做注释。

10.3 **不能使用#作为单行注释, 多行注释/\* *   **/不能出现在同一行。** 

10.4 函数必须通过 @param 和 @return 标记指明其参数和返回值，通过 @throws 指明抛出的异常类型。

10.5 文件、函数、类以及成员变量都必须包含注释。

10.6 前端访问必须有日志记录，记录条数应与访问一一对应。 

10.7 数据库写操作必须有日志记录，记录条数应与操作一一对应。

10.8 统一调用 log_fatal、log_warning、log_trace等。

10.9 当业务不能正常执行（调用第三方失败、与数据库交互失败、客户端传参不对、业务逻辑上数据不对等情况），直接调用log_fatal。等同于线上500错误，一旦出现，立即报警，并马上处理。

10.10 WARNING或者FATAL日志编码格式，如：[level][time][file:no][logid][api:name][errno｜msg] 。

注释规范遵守phpDocumentor注释规范, 更多请参见:  **http://manual.phpdoc.org/**

## 11.安全编码 

**11.1 所有的用户输入都是有害的**，对所有从客户端传入的数据**都不信任**，需要做**判断和过滤**，否则可能会受到SQL Injection、XSS等攻击。

11.2 用户的相关输入涉及数据库操作、文件操作等敏感操作时需要对输入做专门的转换。 

11.3 **用户上传的文件的文件名必须重新命名，并限制其后缀。**

11.4 将php配置中的 register_globals 设置为 Off。 

11.5 将php配置中的**expose_php**设置为**Off**，**避免PHP版本信息暴露。**

11.6 php配置中**error_reporting**的设置：**开发环境**推荐设置error_reporting(E_ALL|E_STRICT)；**线上环境**推荐设置：error_reporting(E_ERROR|E_PARSE)。 

11.7 输入参数作为system、exec、passthru等任何命令执行函数的参数时，要使用**escapeshellarg函数进行过滤**。（escapeshellcmd在某些条件下会存在漏洞，因此**强烈建议**使用escapeshellarg!）

11.8 输入参数作为PHP文件内容时，要使用var_export进行数据导出。

# 四：PSR4 命名空间规则

------

代码框架趋向composer化，其中命名空间psr4的规则尤显重要。



# 五：安全编码规范 附录

------

## 1.准则

从本质上说，需要关注的主要是输入参数的安全性和函数安全性。

1.1  对所有从客户端传入的数据不信任。

1.2  最小化原则。

1.3  安全的编码不依赖任何安全配置。

1.4  程序错误信息对外界透明。

## 2.细则

输入数据的用途及上下文的不同，决定了一个安全漏洞的级别和防御办法的不同。

2.1  输入数据作为数据库操作的一部分

​    2.1.1 环境变量问题: 环境变量过滤。

​    2.1.2 整数型注入：intval过滤。

​    2.1.3 字符串型注入：mysql_real_escape_string。

​    2.1.4 正确使用字符集:utf8。

2.2 输入参数与文件操作相关

​    2.2.1  文件名安全问题：应以白名单方式处理。如果不能用允许的文件名白名单列表，应该定义白名单字符范围。

​    2.2.2  文件上传问题：过滤文件名，验证文件类型，严格限制文件后缀。

​    2.2.3  文件读写内容安全：将输出到文件的数据放到单引号中，而非双引号。

2.3  输入参数与命令执行相关

​    尽量避免使用system，exec，popen,passthru等。如果必须使用这些函数，需要用escapeshellarg过滤参数。

## 3.安全配置

3.1 关闭register_globals。

3.2 开启magic_quotes_gpc。

3.3 关闭display_errors,开启log_errors,配置error_log路径。