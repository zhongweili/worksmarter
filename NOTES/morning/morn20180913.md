# 
* 502 BAD GATEWAY 
* 504 GATEWAY TIMEOUT

502：作为网关或者代理工作的服务器尝试执行请求时，从上游服务器接收到无效的响应。
504：作为网关或者代理工作的服务器尝试执行请求时，未能及时从上游服务器（URI标识出的服务器，例如HTTP、FTP、LDAP）或者辅助服务器（例如DNS）收到响应。　　注意：某些代理服务器在DNS查询超时时会返回400或者500错误。

许多概念，要读好几遍概念才理解，这时不妨借助类比。客户端是客户，网关或代理服务器是饭店，上游服务器是后厨，客户来饭店吃饭，点菜（发请求），服务员指派给后厨做菜（反向代理），后厨大师傅找不到了/病了/出事故了/做错菜了（返回无效响应），服务员无法上菜，给客户道歉（返回502错误）；后厨师傅新来的做菜太慢了，常规时间做不好菜，服务员向客户道歉（返回504错误）；客户点好菜，突然有急事走了，后厨做好菜送过来找不到客人，服务员记一笔坏账（网关记录499错误）；服务员集体罢工，后厨做好菜找不到人送菜，后厨痛骂一顿（上游服务器记录499错误）。

upstream过程
upstream 机制使得 Nginx 成为一个反向代理服务器，Nginx 接收来自下游客户端的 http 请求，并处理该请求，同时根据该请求向上游服务器发送 tcp 请求报文，上游服务器会根据该请求返回相应的响应报文，Nginx 根据上游服务器的响应报文，决定是否向下游客户端转发响应报文。另外 upstream 机制提供了负载均衡的功能，可以将请求负载均衡到集群服务器的某个服务器上面。

upstream机制与上游服务器建立tcp连接时，采用的是非阻塞模式的套接字，即发起连接请求之后立即返回，不管连接是否建立成功，若没有立即建立成功，则需在 epoll 事件机制中监听该套接字。向上游服务器发起连接请求由函数ngx_http_upstream_connect 实现。这部分是由ngx_event_connect_peer完成，具体流程：
* 调用 ngx_socket 方法创建一个 TCP 套接字；
* 调用 ngx_nonblocking 方法设置该 TCP 套接字为非阻塞模式；
* 设置套接字连接接收和发送网络字符流的方法；
* 设置套接字连接上读、写事件方法；
* 将 TCP 套接字以期待 EPOLLIN | EPOLLOUT 事件的方式添加到epoll 事件机制中；
* 调用 connect 方法向服务器发起 TCP 连接请求；



形象比喻：

关于网络i/o，我的理解：

一个饭店（网络服务），有8张桌子（连接的fd）。有下面几种服务模式


A:老板请了8个服务员（进程），分别负责各自的桌子。（apache的prefork模式）

缺点：服务员严重浪费，成本太高。

扩容：如果要支持同时16个顾客，需要增加8个服务员（增加桌子不考虑：因为每一个进程可以打开的fd数远大于8）

并发连接数：进程数


B:老板只请了1个服务员，负责全部的的桌子。但是这个服务员是个瞎子。（select模式）

缺点：有顾客有需求时，服务员依次问每一桌：“是你有需求吗？”（轮询fd)，效率低。

扩容：如果要支持同时16个顾客，不需要增加服务员。

并发连接数：进程数 * 每一个进程可支持的fd数


C:老板只请了1个服务员，负责全部的的桌子。但是这个服务员是个正常人。（epoll模式）

优点：有顾客有需求时，服务员可以直接看到是哪一桌有什么需求，立即响应，无需轮询fd。

扩容：如果要支持同时16个顾客，不需要增加服务员。

并发连接数：进程数 * 每一个进程可支持的fd数